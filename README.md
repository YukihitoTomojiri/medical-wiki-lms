# 医療・介護施設向け 感染対策マニュアルLMS 🏥

あさひ医療グループ内の複数施設（本館、南棟、ひまわりの里病院、あおぞら中央クリニック）を横断して、職員の学習状況と権限を管理するための学習管理システム（LMS）です。医療現場での感染対策知識の平準化と、管理業務の自動化を目的としています。

---

## 🚀 プロジェクト概要

- **目的**: 施設横断的な感染対策マニュアルの共有と学習進捗の可視化。
- **ターゲット**: 看護師、介護士、事務職など、施設に所属する全職員。
- **特徴**: 厳格な監査ログと、職種・拠点に応じた権限管理。

---

## 🛠 技術スタック (Tech Stack)

| カテゴリ | 技術 |
| :--- | :--- |
| **Frontend** | React, Vite, Tailwind CSS, Lucide React (Icons) |
| **Backend** | Java (Spring Boot 3), Spring Security, Hibernate (JPA) |
| **Database** | MySQL 8.0 |
| **Testing** | Vitest (Frontend & API Security Integration) |
| **Infrastructure** | Docker, Docker Compose |
| **DevOps** | Spring Boot DevTools, backend-watcher (inotify), Vite HMR, Vitest Watch |

---

## 📋 開発運用ルール (Development Rules)

スムーズかつ安全な開発を継続するため、以下のルールを定義します。

### 1. 開発の完全自動化
本プロジェクトでは、Docker Compose を活用した「保存即反映」の環境を構築しています。
- **Backend (Hot Reload)**: `backend-watcher` がソースコードの変更を検知し、自動で再コンパイルを実行、DevTools がアプリを再起動します。
- **Frontend (HMR)**: Vite のポーリングモードが有効になっており、Docker上でも確実に画面が更新されます。
- **Testing (Auto Test)**: `vitest-watch` サービスにより、テストがバックグラウンドで常時実行されます。

### 2. Git ブランチ運用ポリシー
機能追加や修正を行う際は、以下の命名規則に従ってブランチを新設します。
- **機能追加**: `feature/機能名`
- **バグ修正**: `fix/課題名`
- **ドキュメント**: `docs/項目名`

> [!NOTE]
> AIエージェントは、新しいタスクを開始する際に自動的にブランチを作成し、その上で作業を行います。

### 3. コマンド自動化とコミット規則
作業完了時、AIエージェントは以下の形式で自動コミットを実行します。
- **形式**: `prefix: 変更内容の要約`
- **プレフィックス例**: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`
- **例**: `feat: ユーザーCSV一括登録機能の実装`

---

## ✨ 実装済みの主要機能

### 🛡️ 権限管理・組織管理
- **4拠点対応**: 本館、南棟、ひまわりの里病院、あおぞら中央クリニックの組織構造を管理。
- **RBAC**: DEVELOPER, ADMIN, USER の3段階ロールによる厳格なアクセス制御。

### 🚨 セキュリティ異常検知 (Security Anomaly Detection)
- **異常アクセス検知**: 以下のパターンを自動検知し、開発者ダッシュボードでアラート表示。
  - **深夜アクセス**: 00:00 - 05:00 (JST) のシステム利用。
  - **短時間大量アクセス**: 1分間に規定回数以上のAPIリクエスト。
  - **大量ダウンロード**: 短時間でのマニュアル大量取得。
  - **ログイン試行エラー**: 連続したログイン失敗の記録。
- **アラート管理**: 重要度（Critical, High, Medium, Low）に応じた色分け表示と、ステータス管理（未確認・確認済み・解決済み）。
- **即時通知**: 開発者ダッシュボードのトップにセキュリティアラートセクションを配置し、システム異常を即座に把握可能。

### 📋 監査ログ & ユーザー管理
- **監査ログ**: 「誰が・いつ・何をしたか」を **JST（日本時間）** で記録。改ざん不可能な証跡保管。
- **ユーザー管理**: 個別追加フォーム ＋ CSV一括登録（ID重複、施設名バリデーション付き）。
- **退職者管理ポリシー**: 
  - **データの永続性**: 退職者は物理削除されず、アーカイブ（論理削除）として保持され、学習履歴や監査ログは失われません。
  - **再就職（復元）対応**: 復職時はCSV一括登録機能がアーカイブ済みIDを検知し、学習履歴を引き継いだ状態で復元・上書き更新を行います。

### 🔑 ハイブリッド・ユーザーオンボーディング
- **柔軟な導入フロー**:
  - **招待リンク方式**: メールやチャットで「招待リンク」を共有し、ユーザー自身がパスワードを設定して利用開始。
  - **仮パスワード発行**: 管理者が「仮パスワード」を発行し、代理で初期設定やサポートを行うことが可能。
- **初回ログイン時のパスワード変更強制**: どちらの方式でも、セキュリティのため初回ログイン時（または仮パスワード使用時）にパスワード変更を強制。

### 🔧 管理者・開発者機能
- **統合開発者ダッシュボード (Integrated Developer Dashboard)**: 
  - システム診断、ユーザー個別登録、監査ログ、および全ユーザーアーカイブをタブ形式で一元管理。
  - ページ遷移時やメニュー選択時にデフォルトの「System Dashboard」へ自動遷移するナビゲーション制御を実装。
  - DEVELOPERロールによる厳格なアクセス制御。

### 🏢 組織管理（施設・部署マスタ）
- **施設マスタ**: 病院・クリニック等の施設を登録・編集・削除（論理削除）。
- **部署マスタ**: 各施設に紐づく部署を登録・編集・削除。
- **データ整合性**: 施設削除時は関連する部署も同時に論理削除。
- **動的連動**: ユーザー登録・編集画面の施設/部署プルダウンは、組織管理マスタと自動連動。

#### 組織の追加手順
1. Developer Dashboard の「**組織管理**」タブを開きます。
2. 「**施設を追加**」ボタンをクリックし、施設名を入力して保存します。
3. 追加した施設の行をクリックして展開し、「**部署を追加**」から部署を登録します。
4. ユーザー登録画面に戻ると、追加した施設・部署がプルダウンに反映されます。

#### UI操作マニュアル
- **施設行の展開/折りたたみ**: 施設名を含む行全体をクリックすることでアコーディオン開閉が可能です（＞アイコンだけでなく行全体が反応）。
- **ホバー表示**: マウスを行に乗せると背景色が変わり、クリック可能であることが視覚的にわかります。
- **ボタン操作**: 編集・削除ボタンはクリック時に行の開閉と競合しないよう設計されています。

> [!TIP]
> 施設を選択すると、その施設に紐付く部署のみがプルダウンに表示されます（連動機能）。

#### 初期データ自動投入とマイグレーション仕様
アプリケーション起動時に `DataSeeder` コンポーネントが以下の処理を実行します：

1. **初期マスタデータの自動投入**:
   - 新規インストール時、以下の施設・部署が自動生成されます：
     - 本館（3階病棟、4階病棟、リハビリテーション、事務部、栄養課）
     - 南棟（2階病棟、3階病棟、透析室）
     - ひまわりの里病院（外来、薬局、検査室）
     - あおぞら中央クリニック（診療外来、訪問看護）

2. **既存データとの互換性**:
   - User テーブルの `facility` / `department` は引き続き文字列として保存
   - 組織マスタと文字列名で紐付けるため、既存ユーザーデータへの影響なし
   - マスタ登録後、ユーザー登録画面のプルダウンに自動反映

> [!IMPORTANT]
> 組織マスタと既存データの整合性を保つため、施設・部署名の表記は統一してください。

#### 重複データの発生防止策
以下の多層防御により、施設・部署データの重複を防止しています：

1. **DB制約**: `departments` テーブルに `(facility_id, name, deleted_at)` のユニーク制約を設定
2. **起動時クリーンアップ**: `DataCleaner` が既存の重複データを自動削除（最小IDを保持）
3. **Seeder のチェック**: `DataSeeder` が `existsBy...` で既存チェック後に投入
4. **フロントエンド重複排除**: ドロップダウン表示時に `Set` で重複を除去

### 📊 コンプライアンスエクスポート
- **CSV/PDFエクスポート**: 学習進捗データを施設・期間でフィルタリングし、CSV/PDF形式でダウンロード可能。
- **施設別フィルタリング**: 複数施設から特定の施設を選択してエクスポート。
- **期間指定**: 開始日・終了日を指定した期間内の進捗データを抽出。
- **Excelと互換性**: CSV出力はUTF-8 BOM付きでExcelでの文字化け対応。
- **ファイル名**: CSVは `compliance_report_YYYYMMDD.csv`、PDFは `compliance_report_YYYYMMDD.pdf` 形式で保存。

> [!TIP]
> **PDF日本語フォント**: PDFはM+ 1 Regular TTFフォントを使用し日本語に対応。

### 🧪 自動テスト & 開発支援
- **常時テスト**: `vitest-watch` コンテナによるフロントエンド・API連携テストの自動実行。
- **フル自動リロード**: Java / TypeScript の変更を検知し、フロント・バック両面で即時反映。

### 🔍 Active Nodes フィルタリング
Active Nodes Control セクションでは、登録ユーザー（ノード）を高度にフィルタリングできます。

- **施設名・ユーザー名検索**: リアルタイム検索入力により、施設名・ユーザー名・部署名で絞り込み。
- **状態フィルタ**: 「稼働中 / 停止中 / 警告あり」のトグルボタンでステータス別に表示。
- **結果カウント**: フィルタ適用後の表示件数がリアルタイムで更新。
- **空結果時**: 「該当するノードが見つかりません」プレースホルダーと「フィルタをクリア」ボタンを表示。

### 💡 追加コストなしの稼働監視
Spring Boot Actuator を活用し、追加の外部サービスやライセンスなしでノード状態監視を実現しています。

- **バックエンド**: `spring-boot-starter-actuator` を使用し `/api/nodes/status` エンドポイントで一括取得。
- **フロントエンド**: 5秒間隔のポーリングでリアルタイム状態更新。
- **ステータス判定**: 最終アクティビティ時刻に基づき UP/WARNING/DOWN を自動判定。
- **日本語対応**: 「稼働中」「警告あり」「停止中」の日本語ラベルで表示。

> [!TIP]
> 追加の監視ツール不要。組み込みヘルスチェック機能を使用しているため運用コストゼロです。

### 🚨 障害発生時の初期対応フロー
Active Nodes ダッシュボードで「警告あり (Warning)」または「停止中 (Offline)」が点滅表示された場合の対応手順です。

1. **ステータス詳細の確認**:
   - 該当ノードの「Facility / Status」列を確認し、詳細メッセージ（例：「通信途絶」「リソース不足」「14日以上未接続」）を読み取ります。
   - ステータスバッジにカーソルを合わせると「最終確認日時」が表示されます。

2. **状況別対応**:
   - **通信途絶 / システムエラー (DOWN)**: ネットワーク接続またはDB稼働状況を確認してください。
   - **リソース不足 (WARNING)**: メモリ使用率が高騰しています。不要なプロセスの停止を検討してください。
   - **長期未接続 (WARNING)**: 最終利用から14日以上経過しています。利用状況を確認してください。

3. **フィルタによる影響範囲の特定**:
   - フィルタで「WARNING」または「DOWN」を選択し、障害が特定の拠点のみかを確認してください。

### 📊 ステータス判定アルゴリズム

| ステータス | ラベル | 条件 | 意味 |
|---|---|---|---|
| **UP** | 🟢 稼働中 | 最終操作から20分以内 | 現在アクティブ (Online) |
| **DOWN** | ⚪ 離席中 | 最終操作から20分以上経過 | 一時的に離席またはオフライン |
| **WARNING** | 🟡 長期未接続 | 最終操作から14日以上経過 | 長期間利用なし (要確認) |
| **WARNING** | 🟡 警告あり | メモリ > 80% / DB遅延 | システムリソース警告 |
| **DOWN** | 🔴 停止中 | DB接続失敗 / システムエラー | システム障害 (System Down) |

---

## 📖 ユーザー向け操作マニュアル (User Manual)

システムの利用方法について説明します。

### 🔐 パスワードを忘れた場合
1. ログイン画面の下にある「**パスワードを忘れた方はこちら**」という文字を押します。
2. **「メールアドレス」** の欄に、ご自身のメールアドレスを入力してください。
3. **「再設定メールを送る」** ボタンを押します。
4. 届いたメールの中にあるリンク（URL）を押すと、パスワード設定画面が開きます。
5. 新しいパスワード（8文字以上）を2回入力し、**「パスワードを変更する」** ボタンを押してください。

### 🔑 初めて利用する場合
管理者から「招待リンク」または「仮パスワード」を受け取ってください。
- **招待リンクの場合**: リンクを開き、ご自身でパスワードを決めて入力すれば登録完了です。
- **仮パスワードの場合**: ログイン画面で「職員番号」と「仮パスワード」を入力してログインしてください。その場ですぐに新しいパスワードへの変更を求められます。

---

## 📦 開発者への約束事

1. **環境の統一**: 常に `docker compose` 環境での動作を標準とし、環境依存を排除します。
2. **Greenなメインブランチ**: `main` ブランチは常にビルド・テストが成功する（Greenな）状態を保ちます。

---

##  開発者向けセットアップ

### 1. 動作環境
- Docker / Docker Compose
- GitHub Desktop (推奨)

### 2. 環境構築
プロジェクト直下で以下のコマンドを実行するだけで、全てのサービス（DB、自動テスト、監視ツール含む）が立ち上がります。

```bash
docker compose up -d
```

### 3. 設定の詳細
- **タイムゾーン**: `Asia/Tokyo` (JST) に統一設定されています。
- **ログ確認**: 各自動化サービスの状況はログで確認できます。
  - バックエンド監視: `docker compose logs -f backend-watcher`
  - 自動テスト状況: `docker compose logs -f vitest-watch`

---

## 🗺️ 今後のロードマップ (Roadmap)

- [ ] **PDFマニュアルの高度化**: アップロード、およびブラウザ内での快適な閲覧機能。
- [ ] **パーソナライズ進捗管理**: 職員ごとの未読・既読リストの強化とリリマインド機能。
- [ ] **修了証発行**: 特定のカテゴリを全て履修した際のデザイン済みPDF発行。
- [ ] **モバイル最適化**: 現場での隙間時間に学習できるレスポンシブ強化。

---

## 📄 ライセンス

Private Project - Internal Use Only
