# ハイブリッド・ユーザーオンボーディング機能 ウォークスルー

本機能は、ITリテラシーの異なる様々な職員がスムーズにシステム利用を開始できるよう、「招待リンク」と「仮パスワード」の2つのオンボーディング方式を提供するものです。

## 1. ユーザー登録（管理者フロー）

`Developer Dashboard` のユーザー登録画面から職員を登録します。
- 以前のような「パスワード入力欄」は削除されています。
- ID、名前、所属、役割のみを入力し `REGISTER` ボタンを押します。

## 2. オンボーディング方式の選択

登録が完了すると、自動的にモーダルが表示され、以下の2つのタブから方式を選択できます。

### A. 招待リンク (INVITE LINK)
**対象**: 自身のスマホやPCでメール/チャットを受け取れる職員

1. **URLのコピー**: 表示された招待URLをコピーします。
2. **共有**: LINE WORKS、メール、チャットなどで該当職員にURLを送付します。
3. **ユーザー体験**:
   - 職員がURLにアクセスすると「アカウントセットアップ画面」が表示されます。
   - 自身のパスワードを設定し `ACTIVATE ACCOUNT` を押すと、即座にログインして利用を開始できます。

### B. 仮パスワード (TEMP PASSWORD)
**対象**: IT操作に不慣れで、対面でのサポートが必要な職員

1. **パスワード発行**: `ISSUE PASSWORD` ボタンを押すと、ランダムな仮パスワード（8文字）が生成されます。
2. **共有**: 口頭またはメモで職員に仮パスワードを伝えます。
3. **ユーザー体験**:
   - 職員はログイン画面から、IDと仮パスワードを入力してログインします。
   - ログイン直後に「パスワード変更画面」へ強制的にリダイレクトされます。
   - 新しいパスワードを設定することで、初めてホーム画面へアクセスできます。

## 3. セキュリティ仕様

- **招待トークン**: 招待リンクに含まれるトークンは、一度アカウント設定に使用されると無効化されます。
- **変更強制フラグ**: 仮パスワード発行時および招待作成時、ユーザーには `mustChangePassword` フラグが立ちます。
  - 招待フロー: 自身のパスワード設定時にフラグが解除されます。
  - 仮パスワードフロー: 初回変更時にフラグが解除されます。
- **未変更時の制限**: フラグが立っている間、ユーザーは `/change-password` 以外のページ（マニュアル一覧など）にはアクセスできず、常に変更画面へ転送されます（ログアウトは可能）。

---
この機能により、現場の状況に合わせた柔軟なアカウント配布が可能となり、管理者・ユーザー双方の負担を軽減します。

## 4. パスワードリカバリー（セルフサービス）

ログイン画面の「パスワードを忘れた方はこちら」リンクから、メールによるパスワードリセットが可能です。
1. **メールアドレス入力**: 登録済みのメールアドレスを入力し、リクエストを送信します。
2. **リセットリンク受信**: メール（モック環境ではコンソールログ）にパスワードリセット用のURLが届きます。
3. **パスワード再設定**: URLにアクセスし、新しいパスワードを設定します。

## 5. 管理機能の強化

`Developer Dashboard` のユーザー管理機能が強化されました。

- **メールアドレス管理**: ユーザー登録時および編集時に、メールアドレスの登録・変更が可能です。
- **管理者リセット**: ユーザー一覧の `RESET` ボタンから、強制的に仮パスワードを発行できます。
  - ボタンを押すと、ランダムな仮パスワードが発行・表示されます。
  - ユーザーは仮パスワードでログイン後、直ちにパスワード変更を求められます。

## 6. 管理者ダッシュボードの強化 (v2.0)

業務効率化のため、管理者ダッシュボードに以下のアクション機能が追加されました。

### A. 進捗遅延対策
- **Lagging Manuals Widget**: ダッシュボード上部に「進捗遅延マニュアル TOP3」が表示されます。全社的に完了率が低いマニュアルを一目で把握できます。

### B. 学習督促 (Remind)
- 職員リストの進捗バーの横に「督促 (Remind)」ボタンが追加されました。
- 未完了の職員に対して、ボタンひとつで督促通知（現在はモック実装としてアラート表示ログ記録）を送信できます。

### C. フィルタ付きCSVエクスポート
- ダッシュボード上の検索条件（施設、部署）で絞り込んだ状態で「CSV出力」ボタンを押すと、表示中の職員データのみを対象とした進捗レポートを即座にダウンロードできます。

## 7. 労務管理と開発者権限の拡張

### A. 有給休暇申請（職員向け）
1. サイドメニューまたはトップページの「**Myダッシュボード**」を開きます。
2. 「有給休暇管理」タブを選択します。
3. 開始日・終了日と理由を入力し、「申請する」ボタンを押します。
   - **有給・勤怠申請**: 「申請種別」から遅刻や早退を選択すると、専用の時間選択（時・分）が表示されます。レイアウトを 5:7 の比率で最適化し、時間選択パーツをコンパクトに配置することで、誤入力を防ぎつつ他の情報との干渉を抑えた設計に刷新しました。なお、有給休暇や欠勤の際は時間入力が自動的に無効化され、不要なバリデーションエラーを防ぐ最適化も施されています。
4. 申請履歴エリアに即座に反映され、ステータス（申請中）が確認できます。

### B. 承認業務（管理者・開発者向け）
1. 管理者ダッシュボードのタブから「**労務管理**」を選択します。
2. 未承認の申請一覧が表示されます。「承認」または「却下」ボタンで判定を行います。
3. 判定結果は即座に職員側の画面にも反映（APPROVED / REJECTED）されます。

### C. 開発者プロキシモード
- `DEVELOPER` 権限を持つユーザーは、管理者ダッシュボードを含む全機能にアクセス可能です。
- 管理エリアにアクセス中は、ヘッダーに**「開発者権限で代行中」**というオレンジ色のバッジが点滅表示され、特権モードであることを明確に示します。

## 8. ユーザー休暇/入社日管理

管理者は、各ユーザーの有給休暇の初期残日数や入社日を管理することができます。

### A. 設定方法（登録時）
- ユーザー個別登録画面に「入社日」と「有給残日数」の項目が追加されました。
- 登録時に入力した値が、そのユーザーの初期設定値となります。

### B. 変更方法（既存ユーザー）
1. `Developer Dashboard` の「稼働状況 (Nodes)」タブを開きます。
2. 該当ユーザーの行にある `EDIT` ボタンをクリックします。
3. インライン編集モードになり、入社日と有給残日数、さらには所属施設や部署も同時に変更可能です。
4. `SAVE` ボタンを押すと、すべての変更が一括でサーバーに送信され、保存されます。
5. 保存成功後、一覧画面は自動的に最新の状態に更新され、変更内容が即座に反映されます。
6. 監査ログには `USER_UPDATE`（または詳細設定時は `USER_LEAVE_UPDATE`）として、どの項目がどのように変更されたかが詳細に記録されます。

### C. ユーザー側への反映
- 設定された「有給残日数」は、ユーザーの「Myダッシュボード」に表示される有給残日数に即座に反映されます。
## 9. 管理者RBACおよび同期修正

施設管理者（ADMIN）の権限制限と、ダッシュボード上の「申請中カウント」の同期問題を解決しました。

### A. ロールベースのアクセス制御 (RBAC) の強化
- **施設限定フィルタリング**:
    - `ADMIN` ロールでログインした場合、**自分が所属する施設**の勤怠・有給申請のみを閲覧・承認できるようバックエンドを修正しました。
    - `DEVELOPER` ロールは、引き続き全施設のデータを閲覧・管理できます。
- **リポジトリ層の拡張**:
    - `AttendanceRequestRepository` および `PaidLeaveRepository` に、施設名によるカウントとリスト取得のメソッドを追加しました。

### B. ダッシュボードの同期とカウント表示
- **即時数値更新**:
    - 有給申請の承認・却下後に、管理画面の「承認待ち」件数が即座に再取得（リロード）されるよう修正しました。
- **開発者ダッシュボードの拡充**:
    - システム統計タブに「未承認の申請」カードを新設。全施設（DEVELOPERの場合）または自施設（ADMINの場合）の保留件数を一目で把握可能にしました。
- **共通サマリーエンドポイント**:
    - フロントエンドから効率的に統計情報を取得できるよう、`/api/admin/summary` エンドポイントを新設しました。

### C. UI/UXの改善
- **状態バッジの日本語化**:
    - 申請一覧のステータス表示を「承認待ち」「承認済み」「却下」に統一。
- **共通ヘッダー情報の整合性**:
    - `PersonalDashboard` と管理者向けサマリーの計算ロジックを共通化し、表示の不一致を解消しました。

### D. 不具合修正
- **有給申請の表示不具合対応**:
    - データベース上の古い `date` カラムが原因で申請データの作成に失敗していた問題を修正しました（DBマイグレーション `V3` の適用）。これにより、職員からの申請が確実に保存され、管理者ダッシュボードに即座に反映されるようになりました。
